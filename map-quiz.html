<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Quiz</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #interactive-map {
            height: 600px;
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 1;
        }
        .leaflet-container {
            background: #1e2a4a;
            border-radius: 12px;
        }
        .custom-marker {
            background: #ff2222;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            margin: 0 !important;
            padding: 0 !important;
        }
        .custom-marker.highlight {
            background: #2e7d32;
            width: 24px !important;
            height: 24px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            margin: 0 !important;
            padding: 0 !important;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }
        .map-control-btn {
            background: rgba(35, 40, 58, 0.95);
            border: 2px solid rgba(58, 122, 254, 0.4);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .map-control-btn:hover {
            background: #3a7afe;
            transform: translateY(-2px);
        }
        .custom-tooltip {
            background: rgba(35, 40, 58, 0.95);
            border: 2px solid rgba(58, 122, 254, 0.4);
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 6px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .custom-tooltip::before {
            border-top-color: rgba(58, 122, 254, 0.4);
        }
        .leaflet-tooltip-top::before {
            border-top-color: rgba(35, 40, 58, 0.95);
        }
        .quiz-input-tooltip {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            pointer-events: auto !important;
        }
        .quiz-input-tooltip::before {
            display: none;
        }
        .quiz-marker-input {
            pointer-events: auto !important;
            cursor: text !important;
        }
        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }
        /* Map selection dropdown styling */
        #map-select {
            background: linear-gradient(135deg, rgba(35, 40, 58, 0.9) 0%, rgba(58, 122, 254, 0.3) 100%);
            color: #fff;
            border: 2px solid rgba(58, 122, 254, 0.4);
            border-radius: 12px;
            padding: 14px 40px 14px 20px;
            font-size: 1.15rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(58, 122, 254, 0.2);
            transition: all 0.3s ease;
            outline: none;
            cursor: pointer;
            min-width: 250px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }
        #map-select:hover {
            background: linear-gradient(135deg, rgba(58, 122, 254, 0.5) 0%, rgba(58, 122, 254, 0.7) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(58, 122, 254, 0.4);
            border-color: #3a7afe;
        }
        #map-select:focus {
            border-color: #3a7afe;
            box-shadow: 0 0 0 4px rgba(58, 122, 254, 0.15);
        }
        #map-select option {
            background: #1e2a4a;
            color: #fff;
            padding: 12px;
            font-size: 1.05rem;
            font-weight: 500;
        }
        #map-select option:hover {
            background: #3a7afe;
        }
        #map-select option:checked {
            background: linear-gradient(135deg, #3a7afe 0%, #5a9aff 100%);
            font-weight: 700;
        }
        #map-selection {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, rgba(58, 122, 254, 0.08) 0%, rgba(35, 40, 58, 0.6) 100%);
            border: 2px solid rgba(58, 122, 254, 0.25);
            border-radius: 16px;
            padding: 24px;
            margin: 0 auto 30px;
            max-width: 900px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        #map-selection label {
            color: #7bb6ff;
            font-size: 1.2rem;
            text-shadow: 0 2px 8px rgba(58, 122, 254, 0.3);
        }
    </style>
</head>
<body>
    <div id="header"></div>
    <main class="center-container glass-bg">
        <h1>Map Quiz</h1>
        
        <!-- Quiz mode selector -->
        <div id="quiz-mode-selector" style="margin-bottom: 20px;">
            <button id="practice-mode-btn" class="mode-btn active">Practice Mode</button>
            <button id="quiz-mode-btn" class="mode-btn">Quiz Mode</button>
        </div>

        <!-- Map selection -->
        <div id="map-selection">
            <label for="map-select">Select Map:</label>
            <select id="map-select">
                <option value="">-- Choose a Map --</option>
            </select>
            <button id="new-world-map-btn" class="main-btn" style="padding:10px 20px; font-size:1rem;">üìç Create New Map</button>
        </div>

        <!-- Map container -->
        <div id="map-container" style="position:relative; width:100%; margin:20px auto; display:none;">
            <div class="map-controls" style="margin-bottom: 10px; position: relative; top: 0; right: 0;">
                <button id="zoom-in-btn" class="map-control-btn">üîç Zoom In</button>
                <button id="zoom-out-btn" class="map-control-btn">üîé Zoom Out</button>
                <button id="reset-view-btn" class="map-control-btn">‚Ü∫ Reset View</button>
            </div>
            <div id="interactive-map"></div>
        </div>

        <!-- Quiz controls -->
        <div id="quiz-controls" style="display:none; margin-top:20px;">
            <div id="current-question" style="font-size:1.3rem; font-weight:600; margin-bottom:15px;">Fill in the labels on the map above, then click Check Answers</div>
            <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                <button id="check-answers-btn" class="main-btn" style="padding:12px 32px;">Check Answers</button>
                <button id="end-quiz-btn" class="main-btn" style="padding:12px 32px; background:#d32f2f;">End Quiz</button>
            </div>
            <div id="feedback-msg" style="margin-top:20px; font-size:1.2rem; font-weight:600;"></div>
        </div>

        <!-- Quiz results -->
        <div id="quiz-results" style="display:none; margin-top:20px;">
            <h2 style="color:#3a7afe;">Quiz Complete!</h2>
            <div id="score-display" style="font-size:1.5rem; margin:20px 0;"></div>
            <button id="retake-quiz-btn" class="main-btn" style="padding:12px 32px;">Retake Quiz</button>
        </div>

        <!-- Edit mode controls (shown when creating/editing maps) -->
        <div id="edit-controls" style="display:none; margin-top:20px;">
            <h3>Edit Map</h3>
            <div style="margin-bottom:15px;">
                <label for="map-name-input" style="font-weight:600;">Map Name:</label>
                <input type="text" id="map-name-input" placeholder="e.g., Global Fleet AORs, PACOM Region" style="width:90%; max-width:400px; margin:8px 0;">
            </div>
            <div style="margin-bottom:15px;">
                <p style="color:#b3c6ff; font-size:1.05rem;">üåç <strong>Pan, zoom, and click</strong> on the world map to mark locations</p>
            </div>
            <div style="margin-bottom:15px;">
                <button id="save-map-btn" class="main-btn" style="padding:10px 24px; background:#3a7afe;">Save Map</button>
                <button id="cancel-edit-btn" class="main-btn" style="padding:10px 24px; background:#d32f2f; margin-left:10px;">Cancel</button>
            </div>
            <!-- Points list -->
            <div id="points-list" style="margin-top:20px;">
                <h4>Added Points:</h4>
                <div id="points-container"></div>
            </div>
        </div>
    </main>
    
    <div id="global-timer-bar"></div>
    <script src="timer-bar.js" defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
        fetch('header.html')
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const header = doc.querySelector('header');
                if (header) document.getElementById('header').appendChild(header);
            });
    </script>
    <script>
        let maps = [];
        let defaultMaps = [];
        let currentMap = null;
        let editMode = false;
        let quizMode = false;
        let currentQuestionIndex = 0;
        let score = 0;
        let answeredQuestions = [];
        let leafletMap = null;
        let markers = [];
        let imageOverlay = null;
        let isWorldMap = false;
        
        // Load default maps from JSON
        function loadDefaultMaps() {
            fetch('json/default_maps.json')
                .then(res => res.json())
                .then(data => {
                    defaultMaps = data;
                    loadMaps();
                })
                .catch(err => {
                    console.error('Failed to load default maps:', err);
                    loadMaps();
                });
        }
        
        // Load maps from localStorage
        function loadMaps() {
            const saved = localStorage.getItem('mapQuizMaps');
            if (saved) {
                try {
                    maps = JSON.parse(saved);
                } catch {
                    maps = [];
                }
            }
            // Combine default maps with user maps
            maps = [...defaultMaps, ...maps];
            renderMapSelect();
        }
        
        // Save maps to localStorage (exclude default maps)
        function saveMaps() {
            const userMaps = maps.filter(m => !m.isDefault);
            localStorage.setItem('mapQuizMaps', JSON.stringify(userMaps));
        }
        
        // Render map selection dropdown
        function renderMapSelect() {
            const select = $('#map-select');
            select.html('<option value="">-- Choose a Map --</option>');
            maps.forEach((map, idx) => {
                select.append(`<option value="${idx}">${map.name}</option>`);
            });
        }
        
        // Initialize Leaflet map
        function initializeLeafletMap() {
            if (leafletMap) {
                leafletMap.remove();
            }
            
            // Create real world map with OpenStreetMap tiles
            // Use custom initial view if provided, otherwise default to world view
            const initialCenter = currentMap.initialCenter || [20, 0];
            const initialZoom = currentMap.initialZoom || 2;
            
            leafletMap = L.map('interactive-map', {
                center: initialCenter,
                zoom: initialZoom,
                minZoom: 2,
                maxZoom: 18,
                zoomControl: false
            });
            
            // Add OpenStreetMap tile layer without labels (using Carto Positron No Labels)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                maxZoom: 18,
                subdomains: 'abcd'
            }).addTo(leafletMap);
            
            // Render markers
            renderWorldMapMarkers();
            
            // Add click handler for edit mode
            if (editMode) {
                leafletMap.on('click', function(e) {
                    const label = prompt('Enter label for this location (e.g., "5th Fleet AOR", "CENTCOM", "Strait of Hormuz"):');
                    if (label) {
                        currentMap.points.push({ 
                            lat: e.latlng.lat, 
                            lng: e.latlng.lng, 
                            label: label 
                        });
                        renderWorldMapMarkers();
                        renderPointsList();
                    }
                });
            }
        }
        
        // Display selected map
        function displayMap(mapIndex) {
            currentMap = maps[mapIndex];
            if (!currentMap) return;
            
            $('#map-container').show();
            initializeLeafletMap();
            
            if (quizMode) {
                startQuiz();
            } else {
                $('#quiz-controls').hide();
                $('#quiz-results').hide();
            }
        }
        
        // Render markers on world map
        function renderWorldMapMarkers() {
            if (!leafletMap || !currentMap || !currentMap.points) return;
            
            // Clear existing markers
            markers.forEach(m => leafletMap.removeLayer(m));
            markers = [];
            
            currentMap.points.forEach((point, idx) => {
                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Create marker at lat/lng
                const marker = L.marker([point.lat, point.lng], { icon: icon });
                
                // Show label in practice mode
                if (!quizMode && !editMode) {
                    marker.bindTooltip(point.label, {
                        permanent: true,
                        direction: 'top',
                        offset: [0, -20],
                        className: 'custom-tooltip'
                    });
                }
                
                // Show input in quiz mode
                if (quizMode) {
                    const inputHtml = `<input type="text" class="quiz-marker-input" data-index="${idx}" placeholder="Enter name..." style="width:150px; padding:6px 8px; border:2px solid #3a7afe; border-radius:6px; background:#1e2a4a; color:#fff; font-size:0.9rem; text-align:center;">`;
                    const tooltip = marker.bindTooltip(inputHtml, {
                        permanent: true,
                        direction: 'top',
                        offset: [0, -20],
                        className: 'custom-tooltip quiz-input-tooltip',
                        interactive: true
                    });
                    
                    // Enable interaction with the tooltip
                    marker.on('tooltipopen', function() {
                        const tooltipEl = document.querySelector('.quiz-input-tooltip');
                        if (tooltipEl) {
                            tooltipEl.style.pointerEvents = 'auto';
                        }
                    });
                }
                
                // Click to remove in edit mode
                if (editMode) {
                    marker.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        if (confirm(`Remove point "${point.label}"?`)) {
                            currentMap.points.splice(idx, 1);
                            renderWorldMapMarkers();
                            renderPointsList();
                        }
                    });
                }
                
                marker.addTo(leafletMap);
                markers.push(marker);
            });
        }
        
        // Start quiz mode
        function startQuiz() {
            if (!currentMap || !currentMap.points || currentMap.points.length === 0) {
                alert('This map has no points to quiz on!');
                return;
            }
            
            score = 0;
            
            $('#quiz-controls').show();
            $('#quiz-results').hide();
            $('#feedback-msg').empty();
            renderWorldMapMarkers();
        }
        
        // Check all answers
        function checkAnswers() {
            let correct = 0;
            let total = currentMap.points.length;
            const results = [];
            
            currentMap.points.forEach((point, idx) => {
                const input = document.querySelector(`.quiz-marker-input[data-index="${idx}"]`);
                if (input) {
                    const userAnswer = input.value.trim();
                    const correctAnswer = point.label;
                    const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    
                    if (isCorrect) {
                        correct++;
                        input.style.borderColor = '#4caf50';
                        input.style.background = 'rgba(76, 175, 80, 0.2)';
                    } else {
                        input.style.borderColor = '#ff2222';
                        input.style.background = 'rgba(255, 34, 34, 0.2)';
                        input.value = `${userAnswer} ‚úó (${correctAnswer})`;
                    }
                }
            });
            
            score = correct;
            const percentage = Math.round((correct / total) * 100);
            
            $('#feedback-msg').html(`
                <div style="background:rgba(35, 40, 58, 0.9); padding:20px; border-radius:12px; border:2px solid #3a7afe;">
                    <div style="font-size:1.5rem; color:#3a7afe; margin-bottom:10px;">Score: ${correct}/${total} (${percentage}%)</div>
                    <div style="font-size:1.1rem; color:${percentage >= 70 ? '#4caf50' : '#ffb13a'}">
                        ${percentage >= 90 ? 'üèÜ Excellent!' : percentage >= 70 ? 'üëç Good job!' : 'üìö Keep practicing!'}
                    </div>
                </div>
            `);
        }
        
        // End quiz
        function endQuiz() {
            quizMode = false;
            $('#quiz-controls').hide();
            $('#quiz-mode-selector').show();
            $('#map-selection').show();
            
            // Switch back to practice mode
            $('#quiz-mode-btn').removeClass('active');
            $('#practice-mode-btn').addClass('active');
            
            renderWorldMapMarkers();
        }
        
        // Edit mode functions
        function enterEditMode(mapIndex = null) {
            editMode = true;
            quizMode = false;
            
            if (mapIndex !== null) {
                currentMap = JSON.parse(JSON.stringify(maps[mapIndex])); // Deep copy
            } else {
                currentMap = {
                    name: '',
                    points: []
                };
            }
            
            $('#map-selection').hide();
            $('#quiz-mode-selector').hide();
            $('#edit-controls').show();
            $('#quiz-controls').hide();
            $('#quiz-results').hide();
            
            $('#map-name-input').val(currentMap.name);
            $('#map-container').show();
            initializeLeafletMap();
            
            renderPointsList();
        }
        
        function renderPointsList() {
            const container = $('#points-container');
            container.empty();
            
            if (!currentMap.points || currentMap.points.length === 0) {
                container.html('<p style="color:#b3c6ff; font-style:italic;">No points added yet. Click on the map to add locations.</p>');
                return;
            }
            
            currentMap.points.forEach((point, idx) => {
                const coords = `(${point.lat.toFixed(2)}¬∞, ${point.lng.toFixed(2)}¬∞)`;
                const pointDiv = $(`
                    <div style="background:#23283a; padding:8px 12px; margin:8px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                        <span><strong>${idx + 1}.</strong> ${point.label} <small style="color:#b3c6ff;">${coords}</small></span>
                        <button class="remove-point-btn" data-idx="${idx}" style="background:#d32f2f; color:#fff; border:none; padding:4px 12px; border-radius:4px; cursor:pointer;">Remove</button>
                    </div>
                `);
                container.append(pointDiv);
            });
            
            $('.remove-point-btn').on('click', function() {
                const idx = $(this).data('idx');
                currentMap.points.splice(idx, 1);
                renderWorldMapMarkers();
                renderPointsList();
            });
        }
        
        function saveMap() {
            currentMap.name = $('#map-name-input').val().trim();
            
            if (!currentMap.name) {
                alert('Please provide a map name!');
                return;
            }
            
            // Save current map view as initial view
            if (leafletMap) {
                const center = leafletMap.getCenter();
                currentMap.initialCenter = [center.lat, center.lng];
                currentMap.initialZoom = leafletMap.getZoom();
            }
            
            if (currentMap.points.length === 0) {
                alert('Please add at least one point to the map!');
                return;
            }
            
            // Check if updating existing non-default map
            const existingIndex = maps.findIndex(m => m.name === currentMap.name && !m.isDefault);
            if (existingIndex >= 0) {
                maps[existingIndex] = currentMap;
            } else {
                // Don't allow overwriting default maps
                if (maps.find(m => m.name === currentMap.name && m.isDefault)) {
                    alert('Cannot overwrite a default map. Please choose a different name.');
                    return;
                }
                maps.push(currentMap);
            }
            
            saveMaps();
            exitEditMode();
            alert('Map saved successfully!');
        }
        
        function exitEditMode() {
            editMode = false;
            currentMap = null;
            
            $('#edit-controls').hide();
            $('#map-selection').show();
            $('#quiz-mode-selector').show();
            $('#map-container').hide();
            
            loadMaps();
        }
        
        // Event handlers
        $('#map-select').on('change', function() {
            const idx = $(this).val();
            if (idx !== '') {
                displayMap(parseInt(idx));
            } else {
                $('#map-container').hide();
                $('#quiz-controls').hide();
                $('#quiz-results').hide();
            }
        });
        
        $('#practice-mode-btn').on('click', function() {
            quizMode = false;
            $(this).addClass('active');
            $('#quiz-mode-btn').removeClass('active');
            $('#quiz-controls').hide();
            $('#quiz-results').hide();
            if (currentMap && leafletMap) {
                renderWorldMapMarkers();
                // Reset to initial view
                const initialCenter = currentMap.initialCenter || [20, 0];
                const initialZoom = currentMap.initialZoom || 2;
                leafletMap.setView(initialCenter, initialZoom);
            }
        });
        
        $('#quiz-mode-btn').on('click', function() {
            quizMode = true;
            $(this).addClass('active');
            $('#practice-mode-btn').removeClass('active');
            if (currentMap) startQuiz();
        });
        
        $('#new-world-map-btn').on('click', function() {
            enterEditMode();
        });
        
        // Map control buttons
        $('#zoom-in-btn').on('click', function() {
            if (leafletMap) leafletMap.zoomIn();
        });
        
        $('#zoom-out-btn').on('click', function() {
            if (leafletMap) leafletMap.zoomOut();
        });
        
        $('#reset-view-btn').on('click', function() {
            if (leafletMap && currentMap) {
                const initialCenter = currentMap.initialCenter || [20, 0];
                const initialZoom = currentMap.initialZoom || 2;
                leafletMap.setView(initialCenter, initialZoom);
            }
        });
        
        $('#save-map-btn').on('click', saveMap);
        $('#cancel-edit-btn').on('click', exitEditMode);
        
        $('#check-answers-btn').on('click', checkAnswers);
        $('#end-quiz-btn').on('click', function() {
            if (confirm('Are you sure you want to end the quiz?')) {
                endQuiz();
            }
        });
        
        $('#retake-quiz-btn').on('click', function() {
            startQuiz();
        });
        
        // Add pulse animation for highlighted pins
        $('<style>@keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.2); } }</style>').appendTo('head');
        
        // Initialize
        loadDefaultMaps();
    </script>
</body>
</html>