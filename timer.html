<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS TOOLS - Multi Timer</title>
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="header"></div>
        <div class="zulu-time-card">
            <div class="zulu-row">
                <div class="zulu-item">
                    <div class="zulu-label">Local Time</div>
                    <div id="localTime" class="zulu-display">--:--:--</div>
                </div>
                <div class="zulu-divider"></div>
                <div class="zulu-item">
                    <div class="zulu-label">Zulu (UTC)</div>
                    <div id="zuluTime" class="zulu-display">--:--:--</div>
                </div>
            </div>
            <div id="zuluDiff" class="zulu-offset">Difference: UTC ±0 hours</div>
        </div>
    <main class="center-container glass-bg">
        <h1>Multi Timer</h1>
        
        <form id="newTimerForm" autocomplete="off" style="margin-bottom: 20px;">
                    <div class="preset-timers">
                        <button type="button" class="preset-btn" data-hours="0" data-minutes="30" data-seconds="0">Boat Timer (30 min)</button>
                        <button type="button" class="preset-btn" data-hours="0" data-minutes="15" data-seconds="0">Heli Timer (15 min)</button>
                        <button type="button" class="preset-btn" data-hours="4" data-minutes="0" data-seconds="0">Cutter Timer (4 hr)</button>
                    </div>
            <div class="timer-form-row">
                <input type="text" id="timerName" placeholder="Timer name" maxlength="30">
            </div>
            <div class="timer-form-row">
                <select id="timerType">
                    <option value="duration">Duration (min:sec)</option>
                    <option value="clock">Clock Time (HH:MM)</option>
                </select>
            </div>
            <span id="durationInput" class="duration-input-group">
                <div class="num-input-wrap">
                    <label for="hours" class="num-label">Hours</label>
                    <input type="number" id="hours" placeholder="Hr" min="0" style="width:55px;" autocomplete="off">
                    <div class="num-btns-row">
                        <button type="button" class="num-up" data-target="hours">▲</button>
                        <button type="button" class="num-down" data-target="hours">▼</button>
                    </div>
                </div>
                :
                <div class="num-input-wrap">
                    <label for="minutes" class="num-label">Minutes</label>
                    <input type="number" id="minutes" placeholder="Min" min="0" max="59" style="width:55px;" autocomplete="off">
                    <div class="num-btns-row">
                        <button type="button" class="num-up" data-target="minutes">▲</button>
                        <button type="button" class="num-down" data-target="minutes">▼</button>
                    </div>
                </div>
                :
                <div class="num-input-wrap">
                    <label for="seconds" class="num-label">Seconds</label>
                    <input type="number" id="seconds" placeholder="Sec" min="0" max="59" style="width:55px;" autocomplete="off">
                    <div class="num-btns-row">
                        <button type="button" class="num-up" data-target="seconds">▲</button>
                        <button type="button" class="num-down" data-target="seconds">▼</button>
                    </div>
                </div>
            </span>
            <span id="clockInput" style="display:none;">
                <input type="time" id="clockTime">
            </span>
            <div class="timer-form-row">
                <button type="submit" id="addTimer" class="">Add Timer</button>
            </div>
        </form>
        <div id="timersList"></div>

    </main>
    <!-- Flashing popup for timer end -->
    <div id="timerPopup">
        <div id="popupContent">
            <span class="flashing">!</span>
            <div id="popupMsg">Time is up!</div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button id="restartTimerBtn" style="padding: 12px 24px; font-size: 1.1rem; background: #3a7afe; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Restart Timer</button>
                <button id="stopTimerBtn" style="padding: 12px 24px; font-size: 1.1rem; background: #d32f2f; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Stop</button>
            </div>
        </div>
    </div>
    <div id="global-timer-bar"></div>
    <audio id="timerAudio" src="audio/alarm.mp3" preload="auto"></audio>
    <script src="timer-bar.js" defer></script>
    <script>
        fetch('header.html')
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const header = doc.querySelector('header');
                if (header) document.getElementById('header').appendChild(header);
            });
    </script>
    <script>
                                        // Zulu (UTC) time sidebar logic
                                        function updateZuluSidebar() {
                                            const now = new Date();
                                            const local = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false});
                                            const zulu = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'UTC'});
                                            const localHour = now.getHours();
                                            const zuluHour = now.getUTCHours();
                                            let diff = localHour - zuluHour;
                                            let sign = diff > 0 ? '+' : (diff < 0 ? '-' : '±');
                                            let absDiff = Math.abs(diff);
                                            // Handle wrap-around (e.g., UTC+10 vs UTC-2)
                                            if (absDiff > 12) {
                                                absDiff = 24 - absDiff;
                                                sign = diff > 0 ? '-' : '+';
                                            }
                                            document.getElementById('localTime').textContent = local;
                                            document.getElementById('zuluTime').textContent = zulu;
                                            document.getElementById('zuluDiff').textContent = `Difference: UTC ${sign}${absDiff} hours`;
                                        }
                                        updateZuluSidebar();
                                        setInterval(updateZuluSidebar, 1000);
                                // Preset timer buttons logic
                                document.querySelectorAll('.preset-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const hours = document.getElementById('hours');
                                        const minutes = document.getElementById('minutes');
                                        const seconds = document.getElementById('seconds');
                                        hours.value = this.dataset.hours;
                                        minutes.value = this.dataset.minutes;
                                        seconds.value = this.dataset.seconds;
                                        hours.dispatchEvent(new Event('input', { bubbles: true }));
                                        minutes.dispatchEvent(new Event('input', { bubbles: true }));
                                        seconds.dispatchEvent(new Event('input', { bubbles: true }));
                                    });
                                });
                        // Custom up/down buttons for time inputs
                        document.querySelectorAll('.num-up').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const input = document.getElementById(this.dataset.target);
                                let max = input.max ? parseInt(input.max) : 9999;
                                let val = parseInt(input.value) || 0;
                                if (val < max) input.value = val + 1;
                                input.dispatchEvent(new Event('input'));
                            });
                        });
                        document.querySelectorAll('.num-down').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const input = document.getElementById(this.dataset.target);
                                let min = input.min ? parseInt(input.min) : 0;
                                let val = parseInt(input.value) || 0;
                                if (val > min) input.value = val - 1;
                                input.dispatchEvent(new Event('input'));
                            });
                        });
                // Auto-correct minutes and seconds to 59 if user enters higher
                document.getElementById('hours').addEventListener('input', function() {
                    if (this.value > 24) this.value = 24;
                    if (this.value < 0) this.value = 0;
                });
                document.getElementById('minutes').addEventListener('input', function() {
                    if (this.value > 59) this.value = 59;
                    if (this.value < 0) this.value = 0;
                });
                document.getElementById('seconds').addEventListener('input', function() {
                    if (this.value > 59) this.value = 59;
                    if (this.value < 0) this.value = 0;
                });
        // Multi-timer logic with persistence
        const timerType = document.getElementById('timerType');
        const durationInput = document.getElementById('durationInput');
        const clockInput = document.getElementById('clockInput');
        const timersList = document.getElementById('timersList');
        const timerPopup = document.getElementById('timerPopup');
        const popupMsg = document.getElementById('popupMsg');
        const newTimerForm = document.getElementById('newTimerForm');
        const timerNameInput = document.getElementById('timerName');
        let timers = [];
        let popupTimerName = '';

        function pad(n) {
            return n.toString().padStart(2, '0');
        }
        function formatTime(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            if (h > 0) {
                return pad(h) + ':' + pad(m) + ':' + pad(s);
            } else {
                return pad(m) + ':' + pad(s);
            }
        }

        function saveTimers() {
            // Save all timers to localStorage
            localStorage.setItem('timers', JSON.stringify(timers.map(t => {
                // Don't save interval property
                const {interval, ...rest} = t;
                return rest;
            })));
        }

        function loadTimers() {
            let saved = localStorage.getItem('timers');
            if (saved) {
                try {
                    timers = JSON.parse(saved);
                } catch {
                    timers = [];
                }
            }
        }

        function updateTimerDisplays() {
            timers.forEach((timer, idx) => {
                // Always recalculate remaining based on endTime for perfect sync
                if (timer.running && timer.endTime) {
                    timer.remaining = Math.max(0, Math.round((timer.endTime - Date.now()) / 1000));
                }
                const el = document.getElementById(`timerDisplay${idx}`);
                if (el) el.textContent = formatTime(timer.remaining);
            });
            // Save to localStorage every update for cross-tab sync
            saveTimers();
        }

        function renderTimers() {
            timersList.innerHTML = '';
            timers.forEach((timer, idx) => {
                const div = document.createElement('div');
                div.style.background = '#23283a';
                div.style.borderRadius = '8px';
                div.style.padding = '12px 18px';
                div.style.margin = '10px 0';
                div.style.width = '100%';
                div.style.maxWidth = '820px';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '18px';
                div.style.boxShadow = '0 2px 8px #0004';
                div.style.boxSizing = 'border-box';

                const name = document.createElement('span');
                name.textContent = timer.name || 'Timer';
                name.style.fontWeight = 'bold';
                name.style.fontSize = '1.2rem';
                name.style.minWidth = '90px';
                name.style.maxWidth = '200px';
                name.style.overflow = 'hidden';
                name.style.textOverflow = 'ellipsis';
                name.style.whiteSpace = 'nowrap';
                name.style.flexShrink = '0';

                // Flex spacer to push timer and buttons to the right
                const spacer = document.createElement('div');
                spacer.style.flex = '1';

                const time = document.createElement('span');
                time.textContent = formatTime(timer.remaining);
                time.style.fontFamily = 'monospace';
                time.style.fontSize = '2rem';
                time.style.letterSpacing = '2px';
                time.style.flexShrink = '0';
                time.id = `timerDisplay${idx}`;

                const startBtn = document.createElement('button');
                startBtn.textContent = timer.running ? 'Pause' : (timer.started ? 'Resume' : 'Start');
                startBtn.style.marginLeft = '10px';
                startBtn.style.padding = '6px 18px';
                startBtn.style.background = timer.running ? '#ffb13a' : '#3a7afe';
                startBtn.style.color = '#fff';
                startBtn.style.border = 'none';
                startBtn.style.borderRadius = '5px';
                startBtn.style.cursor = 'pointer';
                startBtn.onclick = () => toggleTimer(idx);

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.style.marginLeft = '10px';
                removeBtn.style.padding = '6px 12px';
                removeBtn.style.background = '#d32f2f';
                removeBtn.style.color = '#fff';
                removeBtn.style.border = 'none';
                removeBtn.style.borderRadius = '5px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.onclick = () => removeTimer(idx);

                div.appendChild(name);
                div.appendChild(spacer);
                div.appendChild(time);
                div.appendChild(startBtn);
                div.appendChild(removeBtn);
                timersList.appendChild(div);
            });
        }

        let lastFinishedTimerIdx = null;
        function showTimerPopup(name, idx) {
            var audio = document.getElementById('timerAudio');
            if (audio) { audio.currentTime = 0; audio.play(); }
            popupMsg.innerHTML = `<b>${name}</b><br>Time is up!`;
            timerPopup.classList.add('flashing-bg');
            timerPopup.style.display = 'flex';
            lastFinishedTimerIdx = idx;
        }
        function hideTimerPopup() {
            timerPopup.style.display = 'none';
            timerPopup.classList.remove('flashing-bg');
            var audio = document.getElementById('timerAudio');
            if (audio) { audio.pause(); audio.currentTime = 0; }
        }
        function restartTimer() {
            if (lastFinishedTimerIdx !== null && timers[lastFinishedTimerIdx]) {
                let timer = timers[lastFinishedTimerIdx];
                timer.remaining = timer.total;
                timer.display = pad(Math.floor(timer.remaining/60)) + ':' + pad(timer.remaining%60);
                timer.running = false;
                timer.started = false;
                saveTimers();
                renderTimers();
                toggleTimer(lastFinishedTimerIdx);
            }
            hideTimerPopup();
            lastFinishedTimerIdx = null;
        }
        function stopTimer() {
            if (lastFinishedTimerIdx !== null && timers[lastFinishedTimerIdx]) {
                let timer = timers[lastFinishedTimerIdx];
                timer.remaining = timer.total;
                timer.running = false;
                timer.started = false;
                timer.endTime = null;
                saveTimers();
                renderTimers();
            }
            hideTimerPopup();
            lastFinishedTimerIdx = null;
        }
        document.getElementById('restartTimerBtn').addEventListener('click', restartTimer);
        document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);

        timerType.addEventListener('change', function() {
            if (this.value === 'duration') {
                durationInput.style.display = '';
                clockInput.style.display = 'none';
            } else {
                durationInput.style.display = 'none';
                clockInput.style.display = '';
            }
        });

        function removeTimer(idx) {
            if (timers[idx].interval) clearInterval(timers[idx].interval);
            timers.splice(idx, 1);
            saveTimers();
            renderTimers();
        }

        function toggleTimer(idx) {
            const timer = timers[idx];
            if (timer.running) {
                clearInterval(timer.interval);
                // Save the time when paused
                timer.running = false;
                timer.lastPaused = Date.now();
                saveTimers();
            } else {
                // If starting for the first time or after pause, set the end time
                if (!timer.started) {
                    timer.remaining = timer.total;
                    timer.endTime = Date.now() + timer.remaining * 1000;
                } else if (timer.lastPaused) {
                    // Adjust endTime based on how much time was left
                    timer.endTime = Date.now() + timer.remaining * 1000;
                }
                timer.started = true;
                timer.running = true;
                timer.interval = setInterval(() => {
                    // Always recalculate remaining based on endTime for perfect sync
                    timer.remaining = Math.max(0, Math.round((timer.endTime - Date.now()) / 1000));
                    timer.display = pad(Math.floor(timer.remaining/60)) + ':' + pad(timer.remaining%60);
                    updateTimerDisplays();
                    if (timer.remaining <= 0) {
                        clearInterval(timer.interval);
                        timer.display = '00:00';
                        timer.running = false;
                        timer.started = false;
                        saveTimers();
                        showTimerPopup(timer.name || 'Timer', idx);
                        updateTimerDisplays();
                    }
                }, 1000);
                saveTimers();
            }
            renderTimers();
        }

        newTimerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let totalSeconds;
            let name = timerNameInput.value.trim() || 'Timer';
            if (timerType.value === 'duration') {
                const hr = parseInt(document.getElementById('hours').value) || 0;
                const min = parseInt(document.getElementById('minutes').value) || 0;
                const sec = parseInt(document.getElementById('seconds').value) || 0;
                totalSeconds = hr * 3600 + min * 60 + sec;
            } else {
                const now = new Date();
                const [h, m] = document.getElementById('clockTime').value.split(':') || [0,0];
                const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                if (target < now) target.setDate(target.getDate() + 1);
                totalSeconds = Math.floor((target - now) / 1000);
            }
            if (isNaN(totalSeconds) || totalSeconds <= 0) {
                alert('Please enter a valid time.');
                return;
            }
            timers.push({
                name,
                total: totalSeconds,
                remaining: totalSeconds,
                running: false,
                started: false,
                interval: null
            });
            saveTimers();
            renderTimers();
            // Automatically start the new timer
            toggleTimer(timers.length - 1);
            timerNameInput.value = '';
            document.getElementById('hours').value = '';
            document.getElementById('minutes').value = '';
            document.getElementById('seconds').value = '';
            document.getElementById('clockTime').value = '';
        });

        // On page load, restore timers and recalculate remaining time
        loadTimers();
        // Restore intervals for running timers
        timers.forEach((timer, idx) => {
            if (timer.running && timer.endTime) {
                // Recalculate remaining time
                timer.interval = setInterval(() => {
                    // Always recalculate remaining based on endTime for perfect sync
                    timer.remaining = Math.max(0, Math.round((timer.endTime - Date.now()) / 1000));
                    updateTimerDisplays();
                    if (timer.remaining <= 0) {
                        clearInterval(timer.interval);
                        timer.running = false;
                        timer.started = false;
                        saveTimers();
                        showTimerPopup(timer.name || 'Timer', idx);
                        updateTimerDisplays();
                    }
                }, 1000);
            }
        });
        // Always update display on load
        updateTimerDisplays();
        renderTimers();
    </script>
</body>
</html>